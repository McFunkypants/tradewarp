const e=8e3,t=4500,a=1e3,n=100,o=5e4,r=3,l=16,s=100,d=16,h=16;let c,f,g,u,p,m,v,w,x,M,y,b,C,I,z,E=0,k=0,L=0,T=0,U=0,P=0,S=0,O=0,A=[],G=[];let R=new Image;R.onload=Oe;R.onerror=(()=>{console.log("unable to download sprites")});R.src="spritez.min.png";const q=["silicon","tech","food","plants","seeds","parts","meds","shielding","controllers","servers","probes","fuel","pipes","waste","tools","sensors","data"];const D=Object.values(q);function H(e,t,a,n,o,i,r){let l=document.createElement("canvas");let s=o-t;let d=i-a;l.width=s;l.height=d;let h=l.getContext("2d");let c=h.createLinearGradient(0,0,r?0:s,r?d:0);c.addColorStop(0,e);c.addColorStop(1,n);h.fillStyle=c;h.fillRect(t,a,s,d);return l}function Y(e,t="rgba(255,255,255,1)",a="rgba(255,255,255,0)"){let n=document.createElement("canvas");n.width=e*2;n.height=e*2;let o=n.getContext("2d");let i=o.createRadialGradient(e,e,0,e,e,e);i.addColorStop(0,t);i.addColorStop(1,a);o.fillStyle=i;o.beginPath();o.arc(e,e,e,0,2*Math.PI);o.fill();return n}function W(){let a=document.createElement("canvas");a.width=e;a.height=t;let n=a.getContext("2d");for(let a=0,i=0;a<o;a++){i=Z(1,6);g.globalAlpha=Z(.25,1);n.drawImage(u,0,0,u.width,u.height,Q(0,e),Q(0,t),i,i)}g.globalAlpha=1;return a}function X(){let e=document.createElement("canvas");const t=8;e.width=t*2;e.height=t*2;let a=e.getContext("2d");a.beginPath();a.moveTo(0,0);a.lineTo(t,t*2);a.lineTo(t*2,0);a.closePath();a.fillStyle="rgba(0,0,0,0.25)";a.fill();return e}var j=new Image;const F=8;const N=8;const V=-2;const B=8;j.src="boxybold.min.png";j.onload=function(){j.loaded=true};const J="ABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%&'(),./0123456789:?";function K(e,t,a){if(!e)return;if(!j.loaded)return;if(!t)t=0;if(!a)a=0;t=Math.round(t);a=Math.round(a);var n=0;var o=0;var i="";var r=0;for(var l=0;l<e.length;l++){i=e[l];i=i.toUpperCase();if(i=="\n"){n=0;o+=B}r=J.indexOf(i);if(r>=0){cx=r*F;g.drawImage(j,cx,0,F,N,t+n,a+o,F,N)}if(i!="\n")n+=F+V;if(i=="I"||i=="1")n-=3;if(i=="("||i==")")n-=2;if(i=="W"||i=="M")n+=2;if(i=="Y"||i=="N")n+=1}}function Q(e,t){return Math.floor(Math.random()*(t-e+1))+e}function Z(e,t){return Math.random()*(t-e)+e}function $(e){return e[0].toUpperCase()+e.slice(1)}function _(e=3){const t="bcdfghjklmnpqrstvwxz";const a="aeiouy";var n="";for(let o=0;o<e;o++){n+=t[Math.floor(Math.random()*t.length)];n+=a[Math.floor(Math.random()*a.length)]}n=$(n);return n}function ee(e){return e[Math.floor(Math.random()*e.length)]}function te(){u=Y(16,"rgba(255,255,255,0.5)","rgba(255,255,255,0)");p=X();m=Y(32,"rgba(9,255,255,1)","rgba(9,255,255,0)");v=H("rgba(255,255,255,0.5)",0,0,"rgba(255,255,255,0)",1e3,1);C=W();w=H("rgba(0,0,0,0.5)",0,0,"rgba(0,0,0,0)",128,56);x=H("rgba(0,0,0,0.5)",0,0,"rgba(0,0,0,0)",2048,512);M=H("rgba(0,255,255,1)",0,0,"rgba(0,255,255,0)",2048,128);b=H("rgba(255,255,255,0.5)",0,0,"rgba(255,255,255,0)",128,16);y=H("rgba(0,255,255,0.5)",0,0,"rgba(0,255,255,0)",128,16);for(let n=0;n<a;n++){G[n]={n:_(3),spr:2,x:Q(d,e-d),y:Q(h,t-h),ang:0,rotvel:Z(-.025,.025),age:0,creds:0,cargo:[],demand:[],production:[],holdsInUse:Q(1,3)};for(let e=0;e<G[n].holdsInUse;e++){G[n].cargo[ee(q)]=Q(1,99)}}for(let a=0;a<n;a++){A[a]={n:_(),spr:1,x:Q(d,e-d),y:Q(h,t-h),vel:0,ang:Q(0,360),destination:0,holdsInUse:0,maxHolds:r,accel:.02,maxvel:64,age:0,odo:0,creds:0,cargo:[]}}I=A[0]}function ae(e){T=e.clientX;U=e.clientY;P=Math.round(T+E);S=Math.round(U+k);if(I&&I.vel==0){I.ang=Math.atan2(S-I.y,P-I.x)}}function ne(){console.log("next");i=A.indexOf(I)+1;if(i>A.length-1)i=0;I=A[i]}function oe(){console.log("prev");i=A.indexOf(I)-1;if(i<0)i=A.length-1;I=A[i]}function ie(e){console.log("keydown:"+e.key);let t;switch(e.key){case"p":case" ":c=!c;console.log((c?"":"un")+"paused");break;case"z":case"q":case"[":case"-":oe();break;case"x":case"e":case"]":case"Tab":ne();break}}function re(e,t,a){let n=999999999;let o=e[0];let i=0;for(nextone of e){i=Te(t,a,nextone.x,nextone.y);if(n>i){o=nextone;n=i}}return o}function le(e){e.preventDefault();let t=re(A,P,S);let a=Te(t.x,t.y,P,S);let n=re(G,P,S);let o=Te(n.x,n.y,P,S);if(o<l){if(I){I.destination=n;I.routeLength=Le(I,I.destination)}}if(a<l){I=t}}function se(e){O=false;e.preventDefault()}let de;function he(){de=zzfxG(...[,,333,.01,0,.9,4,1.9,,,,,,.5,,.6]);sfxwarp=zzfxG(...[,,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04])}function ce(e,t=.25,a=44100,n=4e3){zzfxV=t;zzfxR=Q(a-n,a+n);if(e)zzfxP(e)}let fe=true;function ge(e){if(fe){fe=false;he()}if(Math.random()>.5)ce(de);else ce(sfxwarp);e.preventDefault();T=e.clientX;U=e.clientY;O=true;if(e.which>1){}else{}P=Math.round(T+E);S=Math.round(U+k);if(f){f=false}}function ue(e,t,a){if(t==undefined)t=e.x-E;if(a==undefined)a=e.y-k+8;t=Math.round(t);a=Math.round(a);let n=0;g.drawImage(w,t-16,a-4);for(hold in e.cargo){n++;K(hold+":"+e.cargo[hold],t+8,a+4);let o=D.indexOf(hold)%17+3;g.drawImage(R,o*d,0,d,h,t-10,a-1,d,h);a+=16}if(!n){g.globalAlpha=.25;K("Cargo holds are empty.\nClick ships and planets to warp.\n\nShips auto-trade to\nmaximize profit.",t-12,a+4);g.globalAlpha=1}}const pe=1;let me=[];let ve=pe;function we(e){ve--;if(ve<1){me=[];timeToRecalculate=true;ve=pe;for(ship of A){for(hold in ship.cargo){if(!me[hold])me[hold]=0;me[hold]+=ship.cargo[hold]}}}let t=16;let a=t;let n=gameCanvas.height-64-4;let o="";let i=0;let r=108;let l=24;if(e){n=4;r=36;t=a=Math.round(gameCanvas.width/2-r*q.length/2)}if(!e){g.drawImage(M,0,n-8-24,gameCanvas.width,24);K("Galactic fleet ("+A.length+" ships) total holdings:",8,n-24);g.drawImage(x,0,n-8,gameCanvas.width,128)}for(let s=0;s<q.length;s++){o=q[s];i=me[o]?me[o]:0;K((e?"":o+":")+i,a+8,n+4);let c=D.indexOf(o)%17+3;g.drawImage(R,c*d,0,d,h,a-10,n-1,d,h);a+=r;if(a>gameCanvas.width-r){n+=l;a=t}}}function xe(e,t){let a=Math.round(e.x-E);let n=Math.round(e.y-k);if(t){a=Math.round(gameCanvas.width/2);n=Math.round(gameCanvas.height/2)}g.drawImage(y,a-64,n-80-16);K(e.n.toUpperCase()+" (cargo ship)",a-64+4,n-75-16);ue(e,a-64+16,n-60-16);g.drawImage(p,a-8,n-16-8);if(e.destination){K(Math.round(Le(e,e.destination))+"au to "+e.destination.n,a+16,n-4)}}const Me=["tropical","lush","icy","frozen","rocky","molten","forest","desolate","dark","cloudy","poisonous","urban","mining","observation","science","bucolic","pastoral","swampy"];const ye=Math.PI/180;function be(e){let t=Math.round(e.x-E);let a=Math.round(e.y-k);g.drawImage(b,t-64,a-80-16);K(e.n.toUpperCase()+" ("+Me[(e.x+e.y*1e5)%Me.length]+" planet)",t-64+4,a-75-16);ue(e,t-64+16,a-60-16);g.drawImage(p,t-8,a-16-8)}function Ce(){g.clearRect(0,0,gameCanvas.width,gameCanvas.height);if(C)g.drawImage(C,-E,-k);z=re(G,P,S);let e=0;for(star of G){if(Ie(star)){e++;if(u){if(z==star){g.drawImage(m,star.x-E-m.width/2,star.y-k-m.height/2)}else{g.drawImage(u,star.x-E-u.width/2,star.y-k-u.height/2)}}g.setTransform(1,0,0,1,star.x-E,star.y-k);g.rotate(star.ang);g.drawImage(R,star.spr*d,0,d,h,-d/2,-h/2,d,h);g.setTransform(1,0,0,1,0,0);if(z==star||I==star){be(star)}}}e=0;for(ship of A){if(Ie(ship,320)){e++;g.setTransform(1,0,0,1,ship.x-E,ship.y-k);g.rotate(ship.ang+Math.PI);if(v)g.drawImage(v,0,0,v.width,v.height,0,-4,ship.vel*64,8);g.rotate(-Math.PI);if(u)g.drawImage(u,0,0,u.width,u.height,-18,-8,16,16);g.drawImage(R,ship.spr*d,0,d,h,-d/2,-h/2,d,h);g.setTransform(1,0,0,1,0,0);if(I==ship||z==ship){xe(ship,true)}}}we();we(true)}function Ie(e,t=64){let a=E-t;let n=E+gameCanvas.width+t;let o=k-t;let i=k+gameCanvas.height+t;return e.x>a&&e.x<n&&e.y>o&&e.y<i}const ze=32;const Ee=.1;function ke(e,t){let a=Le(e,t);if(a>(e.routeLength+l)/2){e.vel+=ship.accel}else{e.vel-=ship.accel}e.vel=Math.min(e.maxvel,e.vel);e.vel=Math.max(Ee,e.vel);e.ang=Math.atan2(t.y-e.y,t.x-e.x);e.prevx=e.x;e.prevy=e.y;e.x+=e.vel*Math.cos(e.ang);e.y+=e.vel*Math.sin(e.ang);e.odo+=Te(e.prevx,e.prevy,e.x,e.y)}function Le(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Te(e,t,a,n){return Math.sqrt(Math.pow(e-a,2)+Math.pow(t-n,2))}function Ue(){if(c)return;for(star of G){star.age++;star.ang+=star.rotvel}for(ship of A){ship.age++;if(ship.destination){var e=Le(ship,ship.destination);if(e>l){ke(ship,ship.destination)}else{console.log(ship.n+" reached destination: "+ship.destination.n);Ae(ship,ship.destination);ship.vel=0;ship.routeLength=0;if(ship.autopilot)ship.destination=ee(G);else ship.destination=null}}else{}}if(I){E=I.x-gameCanvas.width/2;k=I.y-gameCanvas.height/2}}function Pe(e){Ue();Ce();requestAnimationFrame(Pe)}function Se(){gameCanvas.width=window.innerWidth;gameCanvas.height=window.innerHeight}function Oe(){gameCanvas=document.createElement("canvas");document.body.appendChild(gameCanvas);g=gameCanvas.getContext("2d");Se();document.addEventListener("contextmenu",e=>e.preventDefault());window.addEventListener("click",le);window.addEventListener("mouseup",se);window.addEventListener("mousedown",ge);window.addEventListener("mousemove",ae);window.addEventListener("resize",Se);window.addEventListener("keydown",ie);te();Pe()}function Ae(e,t){var a=1;for(hold in t.cargo){if(e.cargo[hold]==undefined&&e.holdsInUse<e.maxHolds){e.holdsInUse++;e.cargo[hold]=a;t.cargo[hold]-=a}else if(t.cargo[hold]>e.cargo[hold]){e.cargo[hold]+=a;t.cargo[hold]-=a}else if(t.cargo[hold]<e.cargo[hold]){e.cargo[hold]-=a;t.cargo[hold]+=a}else{}}}